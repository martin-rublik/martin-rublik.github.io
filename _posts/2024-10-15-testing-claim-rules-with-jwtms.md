---
layout: post
title: "testing claim rules with jwt.ms"
date: 2024-10-15 08:00:00 +0100
tags: entra-id
image: entra-id-custom-claims-testing/entra-id-claims.jpg
toc: include
---

There are
[several](https://learn.microsoft.com/en-us/entra/identity-platform/schema-extensions)
ways to inject [custom
claims](https://learn.microsoft.com/en-us/entra/identity-platform/custom-claims-provider-overview)
into tokens issued by Entra ID. Before diving into those details (may be in future :rocket:), today I'll focus on how you can easily test
claims rules.

In this blog post I'll describe how to use [jwt.ms](https://jwt.ms) for testing
claim rules in the [OAuth2 implicit
flow](https://learn.microsoft.com/en-us/entra/identity-platform/v2-oauth2-implicit-grant-flow). To do this you need:
1. Create an application registration in your Entra ID tenant
2. Craft a redirect URL and test

# Creating an application registration
Creating an application registration is straight-forward: 
1. Navigate to ```Entra Admin Center > App registrations > New registration``` or use [Merill's cmd.ms](https://cmd.ms/), or go directly [https://enappreg.cmd.ms/](https://enappreg.cmd.ms/).
2. Choose a name for the application registration
3. In ```Redirect URI``` choose ```Web``` and ```https://jwt.ms```
4. Press ```Register```

{% include gimage.html uri="/assets/pictures/entra-id-custom-claims-testing/entra-id-claims-register-app.png" %}


After the application is registered you need to enable implicit flow:
1. Navigate to the application you have just registered in ```App registration```
2. Choose ```Authentication```
3. In ```Implicit grant and hybrid flows``` check both:
- :heavy_check_mark: Access tokens (used for implicit flows)
- :heavy_check_mark: ID tokens (used for implicit and hybrid flows)
4. Press ```Save```

{% include gimage.html uri="/assets/pictures/entra-id-custom-claims-testing/entra-id-claims-enable-implicit-flow.png" %}

Now we can start with testing :hammer_and_pick: :computer:.

# Testing claim rules and few notes on implicit flow
According to [Microsoft identity platform and OAuth 2.0 implicit grant flow protocol diagram](https://learn.microsoft.com/en-us/entra/identity-platform/v2-oauth2-implicit-grant-flow#protocol-diagram), the sign-in process should be initiated by application. This is illustrated by next picture, in the very first flow: _SPA redirects user to sign in_.

[![Implicit flow protocol diagram](/assets/pictures/entra-id-custom-claims-testing/entra-id-claims-protocol-diagram.svg)](https://learn.microsoft.com/en-us/entra/identity-platform/v2-oauth2-implicit-grant-flow#protocol-diagram)


Unfortunately, we can't force [jwt.ms](https://jwt.ms) to sign you in via Entra, so we'll need to use a small workaround. We will build the URL manually and use it to initiate sign-in.

According to the [documentation](https://learn.microsoft.com/en-us/entra/identity-platform/v2-oauth2-implicit-grant-flow#send-the-sign-in-request), the following parameters are mandatory in the sign-in request:
- tenant
- client_id
- response_type
- scope
- nonce

Other parameters are optional, but we won't dive into those details today.

| parameter     | description |
|---------------|-------------|
| ```tenant```        | This is basically your Entra ID tenantId, you can easily find it either through Entra administrative center or for example via MgGraph.<br/><br/>```Get-MgOrganization | select -ExpandProperty id```|
| ```client_id```     | The Application (client) ID that was assigned during app creation previously. Either accessible via Entra administrative center or for example via MgGraph.<br/><br/>```Get-MgApplication -Filter "displayName eq 'JWTMS Claims Test'" | select -ExpandProperty AppId```|
| ```response_type``` | ```id_token``` for _id_token_ testing.<br/>```token``` for _access token_ testing.|
| ```scope```         | A space-separated list of _scopes_.<br/><br/> For OpenID Connect (_id_token_), it must include the scope ```openid```, which translates to the "Sign you in" permission in the consent UI.<br/><br/> Optionally you may also want to include the ```email``` and ```profile``` scopes for gaining access to additional user data. <br/><br/> You may also include other scopes in this request for requesting consent to various resources, if an _access token_ is requested. |
| ```nonce```         | A value included in the request, generated by the app, that is included in the resulting ID token as a claim. The app can then verify this value to mitigate token replay attacks. <br/><br/>Since we are just testing claim rules we'll use a constant :facepalm: ```0xdeadbeef```.<br/><br/> Never, ever do this in a application you are creating. **Ever:exclamation:** |

To simplify the URL-building process, I’ve created a simple table that will help
you. Just fill in the necessary parameters, and it will automatically generate
the URL for you. The generation is triggered by _onChange_ JavaScript event, so all you
need to do is click the ```Copy URL...``` button, and the correct URL is
generated.

At minimum, please provide your own ```TenantId``` and ```ClientId```
parameters, otherwise it just won't work :nerd_face:.

<script>
function changeOutput() {
    var output = document.getElementById("output");
    var test = document.getElementById("test");
    output.value = test.value;
}
</script>

<table>
    <tr>
        <td>TenantId:</td>
        <td><input type="text" id="tenantId" onchange="computerOutput()" style="width:100%; background-color:black; color:yellow" value=""></td>
    </tr>
    <tr>
        <td>ClientId:</td>
        <td><input type="text" id="clientId" onchange="computerOutput()" style="width:100%; background-color:black; color:yellow" value=""></td>
    </tr>
    <tr>
        <td>Response type:</td>
        <td>
            <select name="responseType" id="responseType" onchange="computerOutput()" style="width:100%; background-color:black; color:yellow" value="token">            
                <option value="token">token</option>
                <option value="id_token">id_token</option>
            </select>
        </td>
    </tr>
    <tr>
        <td>Scopes:</td>
        <td><input type="text" id="scopes" onchange="computerOutput()" style="width:100%; background-color:black; color:yellow" value=".default openid"></td>
    </tr>
</table>
<input type="button" id="button1" value="Copy URL..." onClick="copyUrl()"><br>
<input type="text" id="fullUrl" style="width:100%; background-color:black; color:#58d68d">

<script>
function computerOutput() {
  var tenantId = document.getElementById("tenantId");
  var clientId = document.getElementById("clientId");
  var responseType = document.getElementById("responseType");
  var scopes = document.getElementById("scopes");

  var fullUrl = document.getElementById("fullUrl");
  fullUrl.value = "https://login.microsoftonline.com/"+tenantId.value+
    "/oauth2/v2.0/authorize?client_id="+clientId.value+
    "/oauth2/v2.0/authorize?client_id="+clientId.value+
    "&response_type="+responseType.value+
    "&redirect_uri=https://jwt.ms/&scope="+scopes.value.replace(" ","%20")+
    "&nonce=0xdeadbeef"
}

function sleep (time) {
  return new Promise((resolve) => setTimeout(resolve, time));
}

async function copyUrl()
{
    var fullUrl = document.getElementById("fullUrl");

    window.navigator.clipboard.writeText(fullUrl.value);
    copyCodeButton=document.getElementById("button1");
    // Update the button text visually
    copyCodeButton.value = 'Copied!';
    sleep(500).then(() => {
        copyCodeButton.value = 'Copy URL...';
    });    
}
computerOutput();
</script>

And short video for the conclusion.

{% include gimage.html uri="/assets/pictures/entra-id-custom-claims-testing/entra-id-claims-testing-w-jwt-ms.gif" %}

Rhymes with [trapdoor solution](https://www.youtube.com/watch?v=pinjeUquJqU)
:laughing:.